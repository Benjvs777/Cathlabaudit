<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audit Dashboard</title>
  <style>
    /* (Your CSS remains exactly the same) */
  </style>
</head>

<!-- âœ… Load Supabase and define functions -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const supabase = supabase.createClient(
  "https://nfkfqwwegptucchhkwgj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ma2Zxd3dlZ3B0dWNjaGhrd2dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NzQzODksImV4cCI6MjA3ODE1MDM4OX0.0U8ljn3x5_V973ufQbRG4p6g9VBTksPaJTLfykepztc"
);

// --- âœ… Save a single checkbox tick to Supabase ---
async function saveItemToDatabase(auditId, itemIndex) {
  const item = checklistState[auditId][itemIndex];
  const user = document.getElementById("user-select").value;

  const record = {
    audit_id: auditId,
    item_name: item.text,
    checked: item.checked,
    user_name: user,
    timestamp: new Date().toISOString()
  };

  const { error } = await supabase.from("audits").insert([record]);
  if (error) console.error("âŒ Error saving item:", error);
  else console.log("âœ… Saved:", record.item_name, record.checked);
}

// (Optional: batch save for full audit if ever needed)
async function saveAudit(auditId) {
  const state = checklistState[auditId];
  const user = document.getElementById("user-select").value;

  const records = state.map(item => ({
    audit_id: auditId,
    item_name: item.text,
    checked: item.checked,
    user_name: item.user || user,
    timestamp: item.timestamp || new Date().toISOString()
  }));

  const { error } = await supabase.from("audits").insert(records);
  if (error) console.error("Save error:", error);
  else alert("Audit saved!");
}

async function loadAuditHistory(auditId) {
  const { data, error } = await supabase
    .from("audits")
    .select("*")
    .eq("audit_id", auditId);
  
  if (error) console.error(error);
  else console.table(data);
}
</script>

<body>
  <div class="dashboard">
    <aside class="sidebar">
      <h2>Audits</h2>
      <ul id="audit-list">
        <li data-id="audit1" class="audit-item"><span class="icon pending"></span> Patient Records</li>
        <li data-id="audit2" class="audit-item"><span class="icon pending"></span> Medication Logs</li>
        <li data-id="audit3" class="audit-item"><span class="icon pending"></span> Equipment Safety</li>
        <li data-id="audit4" class="audit-item"><span class="icon pending"></span> Temperatures</li>
      </ul>
    </aside>

    <main class="content">
      <h2 id="audit-title">Select an audit</h2>

      <div class="user-selector">
        <label for="user-select">Current User:</label>
        <select id="user-select">
          <option value="Nurse A">Nurse A</option>
          <option value="Nurse B">Nurse B</option>
          <option value="Dr. Smith">Dr. Smith</option>
          <option value="Admin">Admin</option>
        </select>
      </div>

      <div class="progress-section">
        <label for="progress">Completion:</label>
        <progress id="progress" value="0" max="100"></progress>
        <span id="progress-text">0%</span>
      </div>

      <ul id="audit-checklist"></ul>
      <button id="amend-button">Amend</button>
    </main>
  </div>

  <script>
    const audits = {
      audit1: {
        title: "Patient Records",
        type: "checklist",
        items: [
          "Verify patient ID",
          "Check admission date",
          "Review discharge summary"
        ]
      },
      audit2: {
        title: "Medication Logs",
        type: "checklist",
        items: [
          "Confirm dosage accuracy",
          "Check administration times",
          "Review allergy documentation"
        ]
      },
      audit3: {
        title: "Equipment Safety",
        type: "checklist",
        items: [
          "Inspect defibrillator",
          "Check oxygen tanks",
          "Review maintenance logs"
        ]
      },
      audit4: {
        title: "Temperatures",
        type: "temperature",
        labs: {
          "Lab 1": ["Room Temperature"],
          "Lab 2": ["Room Temperature"],
          "Lab 3": ["Room Temperature", "Fridge Temperature"],
          "Lab 4": ["Room Temperature"],
          "Lab 5": ["Room Temperature"]
        }
      }
    };

    let currentAuditId = null;
    let checklistState = {};

    function updateProgress() {
      const state = checklistState[currentAuditId];
      let total = 0;
      let filled = 0;

      if (audits[currentAuditId].type === "checklist") {
        total = state.length;
        filled = state.filter(item => item.checked).length;
      } else if (audits[currentAuditId].type === "temperature") {
        for (const lab of state) {
          for (const field of lab.fields) {
            total += 3;
            if (field.max && field.min && field.current) filled += 3;
          }
        }
      }

      const percent = total ? Math.round((filled / total) * 100) : 0;
      document.getElementById("progress").value = percent;
      document.getElementById("progress-text").textContent = `${percent}%`;

      const icon = document.querySelector(`.audit-item[data-id="${currentAuditId}"] .icon`);
      if (percent === 100) {
        icon.classList.remove("pending", "not-required");
        icon.classList.add("completed");
      } else {
        icon.classList.remove("completed", "not-required");
        icon.classList.add("pending");
      }

      const amendButton = document.getElementById("amend-button");
      if (audits[currentAuditId].type === "checklist") {
        const checklistItems = document.querySelectorAll(".check-item");
        if (percent === 100) {
          checklistItems.forEach(cb => cb.disabled = true);
          amendButton.style.display = "inline-block";
        } else {
          checklistItems.forEach(cb => cb.disabled = false);
          amendButton.style.display = "none";
        }
      } else {
        amendButton.style.display = "none";
      }
    }

    function renderChecklist() {
      const checklist = document.getElementById("audit-checklist");
      checklist.innerHTML = "";

      const items = checklistState[currentAuditId];
      items.sort((a, b) => a.checked - b.checked);

      items.forEach((item, index) => {
        const li = document.createElement("li");
        li.className = item.checked ? "checked-item" : "";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "check-item";
        checkbox.checked = item.checked;
        checkbox.id = `task-${index}`;

        const label = document.createElement("label");
        label.htmlFor = `task-${index}`;
        label.textContent = item.text;

        const meta = document.createElement("span");
        meta.className = "meta-info";
        meta.textContent = item.checked ? `âœ” by ${item.user} on ${item.timestamp}` : "";

        // âœ… Auto-save each time a checkbox is ticked
        checkbox.addEventListener("change", () => {
          const selectedUser = document.getElementById("user-select").value;
          item.checked = checkbox.checked;
          item.timestamp = checkbox.checked ? new Date().toLocaleString() : "";
          item.user = checkbox.checked ? selectedUser : "";
          renderChecklist();
          updateProgress();
          saveItemToDatabase(currentAuditId, index); // ðŸ‘ˆ Save instantly
        });

        li.appendChild(checkbox);
        li.appendChild(label);
        li.appendChild(meta);
        checklist.appendChild(li);
      });

      updateProgress();
    }

    function renderTemperatureInputs() {
      const checklist = document.getElementById("audit-checklist");
      checklist.innerHTML = "";

      const labs = checklistState[currentAuditId];

      labs.forEach((lab) => {
        lab.fields.forEach((field) => {
          const li = document.createElement("li");
          li.innerHTML = `<strong>${lab.name} - ${field.name}</strong>`;

          ["max", "min", "current"].forEach(type => {
            const input = document.createElement("input");
            input.type = "number";
            input.placeholder = type;
            input.className = "temp-input";
            input.value = field[type];
            input.addEventListener("input", () => {
              field[type] = input.value;
              updateProgress();
            });
            li.appendChild(input);
          });

          checklist.appendChild(li);
        });
      });

      updateProgress();
    }

    function loadAudit(auditId) {
      currentAuditId = auditId;
      const audit = audits[auditId];
      document.getElementById("audit-title").textContent = audit.title;

      if (audit.type === "checklist") {
        if (!checklistState[auditId]) {
          checklistState[auditId] = audit.items.map(text => ({
            text,
            checked: false,
            timestamp: "",
            user: ""
          }));
        }
        renderChecklist();
      } else if (audit.type === "temperature") {
        if (!checklistState[auditId]) {
          checklistState[auditId] = Object.entries(audit.labs).map(([labName, fields]) => ({
            name: labName,
            fields: fields.map(name => ({
              name,
              max: "",
              min: "",
              current: ""
            }))
          }));
        }
        renderTemperatureInputs();
      }
    }

    document.querySelectorAll(".audit-item").forEach(item => {
      item.addEventListener("click", () => {
        const auditId = item.getAttribute("data-id");
        loadAudit(auditId);
      });
    });

    document.getElementById("amend-button").addEventListener("click", () => {
      const checklistItems = document.querySelectorAll(".check-item");
      checklistItems.forEach(cb => cb.disabled = false);
      document.getElementById("amend-button").style.display = "none";
    });
  </script>
</body>
</html>
