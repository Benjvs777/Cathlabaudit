<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audit Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f4f6f8;
    }

    .dashboard {
      display: flex;
      flex-direction: row;
      height: 100vh;
    }

    .sidebar {
      width: 250px;
      background-color: #2f3e46;
      color: white;
      padding: 20px;
      flex-shrink: 0;
    }

    .sidebar h2 {
      margin-top: 0;
      font-size: 1.2em;
    }

    .audit-item {
      cursor: pointer;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #444;
      transition: background-color 0.3s ease;
      font-size: 1em;
    }

    .audit-item:hover {
      background-color: #3d4f58;
    }

    .icon {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      display: inline-block;
      transition: background-color 0.3s ease;
    }

    .completed {
      background-color: green;
    }

    .pending {
      background-color: orange;
    }

    .not-required {
      background-color: grey;
    }

    .content {
      flex: 1;
      padding: 20px;
      background-color: #fff;
      overflow-y: auto;
    }

    #audit-title {
      margin-top: 0;
      font-size: 1.5em;
    }

    .user-selector {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .user-selector label {
      font-weight: bold;
    }

    .progress-section {
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    progress {
      width: 100%;
      height: 20px;
    }

    #audit-checklist {
      list-style: none;
      padding: 0;
    }

    #audit-checklist li {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .check-item {
      margin-right: 10px;
    }

    .check-item:disabled + label {
      color: #aaa;
    }

    .checked-item {
      background-color: #eee;
      color: #888;
      text-decoration: line-through;
    }

    .meta-info {
      margin-left: auto;
      font-style: italic;
      color: #666;
      font-size: 0.85em;
    }

    .temp-input {
      width: 80px;
      margin-right: 10px;
      font-size: 1em;
      padding: 4px;
    }

    #amend-button {
      margin-top: 20px;
      padding: 10px 16px;
      font-size: 1em;
      background-color: #0077cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: none;
    }

    #amend-button:hover {
      background-color: #005fa3;
    }

    @media (max-width: 768px) {
      .dashboard {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        padding: 10px;
      }

      .audit-item {
        font-size: 1.1em;
      }

      .content {
        padding: 15px;
      }

      .temp-input {
        width: 100px;
      }
    }
  </style>
</head>

<body>
  <div class="dashboard">
    <aside class="sidebar">
      <h2>Audits</h2>
      <ul id="audit-list">
        <li data-id="audit1" class="audit-item"><span class="icon pending"></span> Patient Records</li>
        <li data-id="audit2" class="audit-item"><span class="icon pending"></span> Medication Logs</li>
        <li data-id="audit3" class="audit-item"><span class="icon pending"></span> Equipment Safety</li>
        <li data-id="audit4" class="audit-item"><span class="icon pending"></span> Temperatures</li>
      </ul>
    </aside>

    <main class="content">
      <h2 id="audit-title">Select an audit</h2>

      <div class="user-selector">
        <label for="user-select">Current User:</label>
        <select id="user-select">
          <option value="Nurse A">Nurse A</option>
          <option value="Nurse B">Nurse B</option>
          <option value="Dr. Smith">Dr. Smith</option>
          <option value="Admin">Admin</option>
        </select>
      </div>

      <div class="progress-section">
        <label for="progress">Completion:</label>
        <progress id="progress" value="0" max="100"></progress>
        <span id="progress-text">0%</span>
      </div>

      <ul id="audit-checklist"></ul>
      <button id="amend-button">Amend</button>
    </main>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ðŸ”§ Replace these with your Supabase details
    const supabase = supabase.createClient(
      "https://YOUR_PROJECT.supabase.co",
      "YOUR_ANON_KEY"
    );

    async function saveItemToDatabase(auditId, itemIndex) {
      const item = checklistState[auditId][itemIndex];
      const user = document.getElementById("user-select").value;

      const record = {
        audit_id: auditId,
        item_name: item.text,
        checked: item.checked,
        user_name: user,
        timestamp: new Date().toISOString()
      };

      const { error } = await supabase.from("audits").insert([record]);
      if (error) console.error("Error saving item:", error);
      else console.log("Saved:", record.item_name, record.checked);
    }

    const audits = {
      audit1: {
        title: "Patient Records",
        type: "checklist",
        items: ["Verify patient ID", "Check admission date", "Review discharge summary"]
      },
      audit2: {
        title: "Medication Logs",
        type: "checklist",
        items: ["Confirm dosage accuracy", "Check administration times", "Review allergy documentation"]
      },
      audit3: {
        title: "Equipment Safety",
        type: "checklist",
        items: ["Inspect defibrillator", "Check oxygen tanks", "Review maintenance logs"]
      },
      audit4: {
        title: "Temperatures",
        type: "temperature",
        labs: {
          "Lab 1": ["Room Temperature"],
          "Lab 2": ["Room Temperature"],
          "Lab 3": ["Room Temperature", "Fridge Temperature"],
          "Lab 4": ["Room Temperature"],
          "Lab 5": ["Room Temperature"]
        }
      }
    };

    let currentAuditId = null;
    let checklistState = {};

    function updateProgress() {
      const state = checklistState[currentAuditId];
      let total = 0;
      let filled = 0;

      if (audits[currentAuditId].type === "checklist") {
        total = state.length;
        filled = state.filter(item => item.checked).length;
      }

      const percent = total ? Math.round((filled / total) * 100) : 0;
      document.getElementById("progress").value = percent;
      document.getElementById("progress-text").textContent = `${percent}%`;
    }

    function renderChecklist() {
      const checklist = document.getElementById("audit-checklist");
      checklist.innerHTML = "";

      const items = checklistState[currentAuditId];

      items.forEach((item, index) => {
        const li = document.createElement("li");
        li.className = item.checked ? "checked-item" : "";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "check-item";
        checkbox.checked = item.checked;
        checkbox.id = `task-${index}`;

        const label = document.createElement("label");
        label.htmlFor = `task-${index}`;
        label.textContent = item.text;

        const meta = document.createElement("span");
        meta.className = "meta-info";
        meta.textContent = item.checked ? `âœ” by ${item.user} on ${item.timestamp}` : "";

        checkbox.addEventListener("change", () => {
          const selectedUser = document.getElementById("user-select").value;
          item.checked = checkbox.checked;
          item.timestamp = checkbox.checked ? new Date().toLocaleString() : "";
          item.user = checkbox.checked ? selectedUser : "";
          renderChecklist();
          updateProgress();
          saveItemToDatabase(currentAuditId, index);
        });

        li.appendChild(checkbox);
        li.appendChild(label);
        li.appendChild(meta);
        checklist.appendChild(li);
      });

      updateProgress();
    }

    function loadAudit(auditId) {
      currentAuditId = auditId;
      const audit = audits[auditId];
      document.getElementById("audit-title").textContent = audit.title;

      if (!checklistState[auditId]) {
        checklistState[auditId] = audit.items.map(text => ({
          text,
          checked: false,
          timestamp: "",
          user: ""
        }));
      }
      renderChecklist();
    }

    document.querySelectorAll(".audit-item").forEach(item => {
      item.addEventListener("click", () => {
        const auditId = item.getAttribute("data-id");
        loadAudit(auditId
